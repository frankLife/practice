<!DOCTYPE html>
<html lang="en">
<head>
<title>chapetr7</title>
</head>
<body>
<canvas width="960" height="500"></canvas>
<script>
(function(){
  var canvas = document.getElementsByTagName('canvas')[0];
  var ctx = canvas.getContext('2d');
  var imgMap = {};
  imgMap['alien'] = new Image();
  imgMap['alien'].src = "./spaceRes/alien.png";
  imgMap['missile'] = new Image();
  imgMap['missile'].src = "./spaceRes/missile.png";
  imgMap['player'] = new Image();
  imgMap['player'].src = "./spaceRes/player.png";
  var audioType = supportType();
  var audioMap = {};
  audioMap['explode'] = document.createElement('audio');
  audioMap['explode'].src = "./spaceRes/explode1" + audioType;
  audioMap['shoot'] = document.createElement('audio');
  audioMap['shoot'].src = "./spaceRes/explode1" + audioType;
  
  function itemsLoad(callback){
    this.count = 0;
    this.start = null;
    this.callback = callback;
    this.sourceEl = [];
  }
  itemsLoad.prototype.loadTrigger = function(el){
    this.count--;
    for(var i = 0,len = this.sourceEl.length;i<len;i++) {
      if(this.sourceEl[i]['el'] == el) {
        this.sourceEl[i]['isLoaded'] = true;
        break;
      }
    }
    if(i == len ){
      throw '加载资源出错';
    }
    if(this.count == 0) {
      this.callback();
    }
  }
  itemsLoad.prototype.loadAdd = function(el){
    this.sourceEl.push({el:el,isLoaded:false});
    this.count++;
  }
  loadInit();
  function loadInit(){
    var loader = new itemsLoad(function(){
      console.log('resoure load done');
    });
    for(var img in imgMap) {
      loader.loadAdd(imgMap[img]);
      imgMap[img].addEventListener('load',function(){
        loader.loadTrigger(this);
      });
    }
    for(var audio in audioMap) {
      loader.loadAdd(audioMap[audio]);
      audioMap[audio].addEventListener('canplaythrough',function(){
        loader.loadTrigger(this);
      });
    }
  }

  function supportType(){
    var returnExtension = '';
    var audioForType = document.createElement('audio');   
    var checkTypeArray = ['ogg','wav','mp3'];
    for(var i = 0,len = checkTypeArray.length;i<len;i++) {
      var itemType = checkTypeArray[i];
      if(audioForType.canPlayType('audio/'+ itemType) == 'probably' ||audioForType.canPlayType('audio/'+itemType) == 'maybe' ) {
        returnExtension = '.' + itemType
        break;
      }
    }

    return returnExtension;
  }


})()
</script>
</body>
</html>