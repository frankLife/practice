<!DOCTYPE html>
<html lang="en">
<head>
<title>chapter7-canvasAudio</title>
</head>
<body>
<canvas width="960" height="500"></canvas>
<script>
(function(){
  var canvas = document.getElementsByTagName('canvas')[0];
  var ctx = canvas.getContext('2d');
  var audio = null;
  var img = new Image();
  img.src = "./audiocontrols.png";
  var controlMap = {
    play: {x: 2,y:1,width: 29,height: 29},
    pause: {x:2,y:33,width: 29,height: 29},
    progressBar: {x: 34,y:1,width: 203,height:29},
    tracker: {x:240,y:1,width: 7,height: 29},
    volume: {x:34,y:33,width: 45,height: 29},
    loopOn: {x: 203,y: 33,width:29,height: 29},
    loopOff: {x:115,y:33,width:29,height:29}
  }

  function itemsLoad(){
    this.count = 0;
    this.start = null;
  }
  itemsLoad.prototype.loadTrigger = function(){

  }
  itemsLoad.prototype.loadAdd = function(){

  }


  init();
  function init(){
    reset();
    // initAudio();
  }
  function initControl(){

  }
  function trackStatus(){

    var startX = 20;
    var startY = 20;
    var increaseX = 200;
    var increaseY = 20;
    var propArray = [
      'duration',
      'currentTime',
      'loop',
      'autoplay',
      'muted',
      'controls',
      'volume',
      'paused',
      'ended',
      'currentSrc'
    ];
    reset();
    ctx.save();
    ctx.fillStyle = 'red';
    ctx.font = 'bold normal 13px sans-serif';

    for(var i = 0,len = propArray.length;i<len;i++) {
      ctx.fillText(propArray[i]+' : '+audio[propArray[i]],startX,startY);

      startX += increaseX;
      if(i%2 == 1) {
        startX = 20;
        startY += increaseY;
      }
    }
    ctx.restore();
  }
  function initAudio(){
    audio = document.createElement('audio');
    var initType = audioSupportType();
    if(initType == '') {
      return;
    }
    audio.src = './audio/song1.' + initType;
    document.body.appendChild(audio);
    audio.addEventListener('canplaythrough',function(){
      this.play();
      timer(trackStatus);
    });
  }

  function audioSupportType(){
    var returnExtension = '';
    if(audio.canPlayType('audio/ogg') == 'probably' || audio.canPlayType('audio/ogg') == 'maybe'){
      returnExtension = 'ogg';
    }else if (audio.canPlayType('audio/wav') == 'probably' || audio.canPlayType('audio/wav') == 'maybe') {
      returnExtension = 'wav';
    }else if(audio.canPlayType('audio/mp3') == 'probably' || audio.canPlayType('audio/mp3') == 'maybe') {
      returnExtension = 'mp3';
    }

    return returnExtension;
  }
  function reset(){
    ctx.save();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "#777";
    ctx.fillStyle = '#eee';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeRect(2,2,canvas.width-4,canvas.height-4);
    ctx.restore();
  }
  function timer(func,time){
    if(time == undefined) {
      (function _pollFunc(){
        window.requestAnimationFrame(function(){
          func();
          _pollFunc();
        });
      })();
    }else {
      (function _pollFunc(){
        setTimeout(function(){
          func();
          _pollFunc();
        },time);
      })();
    }
  }
})()
</script>

</body>
</html>